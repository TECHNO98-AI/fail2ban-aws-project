name: CI - lint, validate & deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: Validate scripts & JSON
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq shellcheck

      - name: Run shellcheck on scripts
        run: |
          echo "Running shellcheck on scripts/*.sh"
          shellcheck -x scripts/*.sh

      - name: Validate CloudWatch JSON
        run: |
          echo "Validating cloudwatch-agent/amazon-cloudwatch-agent.json"
          jq -e . cloudwatch-agent/amazon-cloudwatch-agent.json >/dev/null

      - name: Validate dashboard JSON
        run: |
          echo "Validating fail2ban-dashboard.json"
          jq -e . fail2ban-dashboard.json >/dev/null

  deploy:
    name: Deploy artifacts (S3 upload)
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Use either OIDC assume-role (recommended) or secrets. See notes below.
      - name: Configure AWS credentials (secrets)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Optional: if you prefer OIDC (more secure) replace above step with:
      # - name: Configure AWS credentials (OIDC)
      #   uses: aws-actions/configure-aws-credentials@v2
      #   with:
      #     role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/<GitHub_OIDC_RoleName>
      #     aws-region: ${{ secrets.AWS_REGION }}

      - name: Show aws cli version
        run: aws --version

      - name: Run deploy script (uploads dashboard and agent JSON to S3)
        env:
          S3_BUCKET: ${{ secrets.DEPLOY_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          chmod +x .github/deploy/deploy.sh || true
          .github/deploy/deploy.sh
